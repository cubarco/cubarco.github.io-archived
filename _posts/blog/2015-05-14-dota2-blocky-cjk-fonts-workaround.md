---
title: 一个解决 Linux 版 DotA2 中 CJK字符显示成方块的 Workaround
layout: post
categories: blog
tags:
  - Linux
  - Steam
  - DotA2
  - Fonts
  - CJK
---

不知道从什么时候开始，Linux 版本的 DotA2 中载入界面的 tips sentences 和 player name 中的中文会显示成方框，详见 [issue-1688](https://github.com/ValveSoftware/Dota-2/issues/1688)。V社基本没搭理这个 bug，只好自己动手修。

猜想是游戏内直接使用了某个字体，或者该字体不存在时调用了默认字体，但是这个字体不支持 CJK 字符，所以显示成方块。因为 SteamFonts 给的全是`Arial`字体，所以我猜是`Arial`，开`FC_DEBUG`跑了一遍 DotA2 发现果然是`Arial`。那么我们要做的就是用`fontconfig`把`Arial`替换成支持中文的字体。

## 解决办法
替换`Arial`的`fontconfig`配置是:
{% highlight xml %}
<match target="pattern">
    <test qual="any" name="family"><string>Arial</string></test>
    <edit name="family" mode="assign" binding="same"><string>Noto Sans S Chinese</string></edit>
</match>
{% endhighlight %}
我用的是`Noto Sans S Chinese`，如果用文泉驿正黑就改成`WenQuanYi Zen Hei`。

怎么使这个配置生效？有两个方法。

###### 环境变量 FONTCONFIG_FILE
这个方法需要一个为 DotA2 单独准备的`fontconfig_file`，姑且命名为`dota2-fontconfig.conf`。

文件内容如下:
{% highlight xml %}
<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "fonts.dtd">
<!-- /etc/fonts/fonts.conf file to configure system font access -->
<fontconfig>

<!--
  DO NOT EDIT THIS FILE.
  IT WILL BE REPLACED WHEN FONTCONFIG IS UPDATED.
  LOCAL CHANGES BELONG IN 'local.conf'.

  The intent of this standard configuration file is to be adequate for
  most environments.  If you have a reasonably normal environment and
  have found problems with this configuration, they are probably
  things that others will also want fixed.  Please submit any
  problems to the fontconfig bugzilla system located at fontconfig.org

  Note that the normal 'make install' procedure for fontconfig is to
  replace any existing fonts.conf file with the new version.  Place
  any local customizations in local.conf which this file references.

  Keith Packard
-->

<!-- Font directory list -->

  <dir>/usr/share/fonts</dir>
  <dir>/usr/share/fonts</dir>
  <dir prefix="xdg">fonts</dir>
  <!-- the following element will be removed in the future -->
  <dir>~/.fonts</dir>

<!--
  Accept deprecated 'mono' alias, replacing it with 'monospace'
-->
  <match target="pattern">
    <test qual="any" name="family">
      <string>mono</string>
    </test>
    <edit name="family" mode="assign" binding="same">
      <string>monospace</string>
    </edit>
  </match>

<!--
  Accept alternate 'sans serif' spelling, replacing it with 'sans-serif'
-->
  <match target="pattern">
    <test qual="any" name="family">
      <string>sans serif</string>
    </test>
    <edit name="family" mode="assign" binding="same">
      <string>sans-serif</string>
    </edit>
  </match>

<!--
  Accept deprecated 'sans' alias, replacing it with 'sans-serif'
-->
  <match target="pattern">
    <test qual="any" name="family">
      <string>sans</string>
    </test>
    <edit name="family" mode="assign" binding="same">
      <string>sans-serif</string>
    </edit>
  </match>

<!--
  Load local system customization file
-->
  <include ignore_missing="yes">conf.d</include>

<!-- Font cache directory list -->

  <cachedir>/var/cache/fontconfig</cachedir>
  <cachedir prefix="xdg">fontconfig</cachedir>
  <!-- the following element will be removed in the future -->
  <cachedir>~/.fontconfig</cachedir>

  <match target="pattern">
      <test qual="any" name="family"><string>Arial</string></test>
      <edit name="family" mode="assign" binding="same"><string>Noto Sans S Chinese</string></edit>
  </match>

  <config>
<!--
  Rescan configuration every 30 seconds when FcFontSetList is called
 -->
    <rescan>
      <int>30</int>
    </rescan>
  </config>

</fontconfig>
{% endhighlight %}
然后用`FONTCONFIG_FILE`环境变量来传递。但是使用这个环境变量之后，`fontconfig`不会再加载其他字体配置文件，所以这里把`/etc/fonts/fonts.conf`的内容也包含进来。[^1]

然后这样打开 Steam:
{% highlight sh %}
export FONTCONFIG_FILE=/path/to/dota2-fontconfig.conf
steam
{% endhighlight %}
再运行 DotA2 就不会有方块的困扰了。

###### 写进`fonts.conf`
直接把字体替换的配置写进`fonts.conf`，比如`~/.fonts.conf`或者`$XDG_CONFIG_HOME/fontconfig/fonts.conf`。

当然这个方法并不推荐，因为会影响到其他程序。

#### Reference
[^1]: [fonts-conf](http://www.freedesktop.org/software/fontconfig/fontconfig-user.html)
