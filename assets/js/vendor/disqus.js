function DisqusJS(config){((window,document,localStorage,fetch,Promise)=>{function _extends(...args){_extends=Object.assign||function(target){for(let i=0,len=arguments.length;i<len;i++){const source=arguments[i];for(const key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};return _extends.apply(this,args)}const $$=elementID=>document.getElementById(elementID);const msg=str=>{const msgEl=$$("dsqjs-msg");if(msgEl)msgEl.innerHTML=str};const CLICK="click";const DISQUS_CONTAINER_EL_ID="disqus_thread";const DSQJS_STORAGE_KEY_SORT_TYPE="dsqjs_sort";const HTML_TPL_A_ATTR=`target="_blank" rel="external nofollow noopener noreferrer"`;const HTML_TPL_EL_MSG=`<div id="dsqjs-msg"></div>`;const HTML_TPL_EL_FOOTER=`<footer><p class="dsqjs-footer">Powered by <a class="dsqjs-disqus-logo" href="https://disqus.com" ${HTML_TPL_A_ATTR}></a>&nbsp;&amp;&nbsp;<a href="https://disqusjs.skk.moe" target="_blank">DisqusJS</a></p></footer>`;const HTML_TPL_EL_HEADER=(num,title)=>`<header class="dsqjs-header" id="dsqjs-header"><nav class="dsqjs-nav dsqjs-clearfix"><ul><li class="dsqjs-nav-tab dsqjs-tab-active"><span>${num} Comments</span></li><li class="dsqjs-nav-tab">${title}</li></ul><div class="dsqjs-order"><input class="dsqjs-order-radio" id="dsqjs-order-desc" type="radio" name="comment-order" value="desc" checked="true"><label class="dsqjs-order-label" for="dsqjs-order-desc" title="按从新到旧">最新</label><input class="dsqjs-order-radio" id="dsqjs-order-asc" type="radio" name="comment-order" value="asc"><label class="dsqjs-order-label" for="dsqjs-order-asc" title="按从旧到新">最早</label><input class="dsqjs-order-radio" id="dsqjs-order-popular" type="radio" name="comment-order" value="popular"><label class="dsqjs-order-label" for="dsqjs-order-popular" title="按评分从高到低">最佳</label></div></nav></header>`;const HTML_TPL_EL_COMMENT=({avatarEl,createdAt},authorEl,message)=>`<div class="dsqjs-post-item dsqjs-clearfix"><div class="dsqjs-post-avatar">${avatarEl}</div><div class="dsqjs-post-body"><div class="dsqjs-post-header">${authorEl}<span class="dsqjs-meta"><time>${formatDate(createdAt)}</time></span></div><div class="dsqjs-post-content">${message}</div></div></div>`;const HTML_TPL_EL_ASK_FOR_FULL='如需完整体验请针对 disq.us | disquscdn.com | disqus.com 启用代理并 <a id="dsqjs-reload-disqus" class="dsqjs-msg-btn">尝试完整 Disqus 模式</a> | <a id="dsqjs-force-disqus" class="dsqjs-msg-btn">强制完整 Disqus 模式</a>';const _get=url=>fetch(url,{method:"GET"}).then(resp=>Promise.all([resp.ok,resp.status,resp.json(),resp.headers])).then(([ok,status,data,headers])=>{if(ok){return{ok:ok,status:status,data:data,headers:headers}}else{throw new Error}}).catch(error=>{throw error});const setLS=(key,value)=>{try{localStorage.setItem(key,value)}catch(e){}};const formatDate=date=>{const x=input=>input<10?`0${input}`:input;date=Date.parse(new Date(date));date=new Date(date+8*60*60*1e3);const y=date.getFullYear();const m=x(date.getMonth()+1);const d=x(date.getDate());const h=x(date.getHours());const minute=x(date.getMinutes());return`${y}-${m}-${d} ${h}:${minute}`};function loadDisqus(){if(window.DISQUS){window.DISQUS.reset({reload:true,config(){this.page.identifier=disqusjs.config.identifier;this.page.url=disqusjs.config.url;this.page.title=disqusjs.config.title}})}else{const s=document.createElement("script");$$(DISQUS_CONTAINER_EL_ID).innerHTML=`<div id="dsqjs"><section><div id="dsqjs-msg">评论完整模式加载中... 如果长时间无法加载，请针对 disq.us | disquscdn.com | disqus.com 启用代理，或切换至 <a id="dsqjs-force-dsqjs" class="dsqjs-msg-btn">评论基础模式</a></div></section>${HTML_TPL_EL_FOOTER}</div>`;$$("dsqjs-force-dsqjs").addEventListener(CLICK,useDsqjs);s.src=`https://${disqusjs.config.shortname}.disqus.com/embed.js`;s.defer=true;s.async=true;s.setAttribute("data-timestamp",+new Date);(document.head||document.body).appendChild(s)}}function checkDisqus(){$$(DISQUS_CONTAINER_EL_ID).innerHTML=`<div id="dsqjs"><section><div id="dsqjs-msg">正在检查 Disqus 能否访问...</div></section>${HTML_TPL_EL_FOOTER}</div>`;const runcheck=domain=>{return new Promise((resolve,reject)=>{const img=new Image;const timeout=setTimeout(()=>{img.onerror=img.onload=null;reject()},3e3);img.onerror=()=>{clearTimeout(timeout);reject()};img.onload=()=>{clearTimeout(timeout);resolve()};img.src=`https://${domain}/favicon.ico?${+new Date}=${+new Date}`})};return Promise.all([runcheck("disqus.com"),runcheck(`${disqusjs.config.shortname}.disqus.com`)]).then(useDisqus,useDsqjs)}function assignClickEventForAskForFulButton(){$$("dsqjs-reload-disqus").addEventListener(CLICK,checkDisqus);$$("dsqjs-force-disqus").addEventListener(CLICK,useDisqus)}function loadDsqjs(){msg(`评论基础模式加载中... ${HTML_TPL_EL_ASK_FOR_FULL}`);assignClickEventForAskForFulButton();const url=`${disqusjs.config.api}3.0/threads/list.json?forum=${encodeURIComponent(disqusjs.config.shortname)}&thread=${encodeURIComponent(`ident:${disqusjs.config.identifier}`)}&api_key=${encodeURIComponent(apikey())}`;_get(url).then(({data})=>{if(data.code===0&&data.response.length===1){const{id,title,isClosed,posts:length}=data.response[0];disqusjs.page={id:id,title:title,isClosed:isClosed,length:length,comment:[]};$$(DISQUS_CONTAINER_EL_ID).innerHTML=`<div id="dsqjs"><div id="dsqjs-msg">评论基础模式加载中... ${HTML_TPL_EL_ASK_FOR_FULL}</div>${HTML_TPL_EL_HEADER(length,disqusjs.config.siteName)}<section class="dsqjs-post-container"><ul class="dsqjs-post-list" id="dsqjs-post-container"><p class="dsqjs-no-comment">评论列表加载中...</p></ul><a id="dsqjs-load-more" class="dsqjs-load-more dsqjs-hide">加载更多评论</a></section>${HTML_TPL_EL_FOOTER}</div>`;assignClickEventForAskForFulButton();$$(`dsqjs-order-${disqusjs.sortType}`).setAttribute("checked","true");getComment()}else if(data.code===0&&data.response.length!==1){msg('当前 Thread 尚未创建。是否切换至 <a id="dsqjs-force-disqus" class="dsqjs-msg-btn">完整 Disqus 模式</a>？');$$("dsqjs-force-disqus").addEventListener(CLICK,useDisqus)}else{throw new Error}}).catch(loadError);const getComment=(cursor="")=>{const $loadMoreBtn=$$("dsqjs-load-more");const $orderRadio=document.getElementsByClassName("dsqjs-order-radio");const $loadHideCommentInDisqus=document.getElementsByClassName("dsqjs-has-more-btn");const unregisterListenerForSwitchTypeRadioAndGetMoreCommentBtn=()=>{Array.prototype.slice.call($orderRadio).forEach(i=>i.removeEventListener("change",switchSortType));$loadMoreBtn.removeEventListener(CLICK,getMoreComment);Array.prototype.slice.call($loadHideCommentInDisqus).forEach(i=>i.removeEventListener(CLICK,checkDisqus))};const getMoreComment=()=>{unregisterListenerForSwitchTypeRadioAndGetMoreCommentBtn();getComment(disqusjs.page.next)};const getCommentError=()=>{if(cursor===""){loadError()}else{$loadMoreBtn.classList.remove("dsqjs-disabled");$loadMoreBtn.innerHTML="加载更多评论失败，点击重试";$loadMoreBtn.addEventListener(CLICK,getMoreComment)}};const switchSortType=({target})=>{disqusjs.sortType=target.getAttribute("value");setLS(DSQJS_STORAGE_KEY_SORT_TYPE,disqusjs.sortType);unregisterListenerForSwitchTypeRadioAndGetMoreCommentBtn();disqusjs.page.comment=[];disqusjs.page.next="";$$("dsqjs-post-container").innerHTML='<p class="dsqjs-no-comment">正在切换排序方式...</p>';$loadMoreBtn.classList.add("dsqjs-hide");getComment()};const cursorParam=cursor===""?"":`&cursor=${cursor}`;$loadMoreBtn.classList.add("dsqjs-disabled");const sortCommentParseDate=({createdAt})=>Date.parse(new Date(createdAt));const sortCommentparentAsc=(a,b)=>{if(a.parent&&b.parent){return sortCommentParseDate(a)-sortCommentParseDate(b)}else{return 0}};const url=`${disqusjs.config.api}3.0/threads/listPostsThreaded?forum=${encodeURIComponent(disqusjs.config.shortname)}&thread=${encodeURIComponent(disqusjs.page.id)}${encodeURIComponent(cursorParam)}&api_key=${encodeURIComponent(apikey())}&order=${encodeURIComponent(disqusjs.sortType)}`;_get(url).then(({data})=>{if(data.code===0&&data.response.length>0){$loadMoreBtn.classList.remove("dsqjs-disabled");disqusjs.page.comment.push(...data.response);disqusjs.page.comment.sort(sortCommentparentAsc);renderComment(disqusjs.page.comment);Array.prototype.slice.call($orderRadio).forEach(i=>i.addEventListener("change",switchSortType));Array.prototype.slice.call($loadHideCommentInDisqus).forEach(i=>i.addEventListener(CLICK,checkDisqus));if(data.cursor.hasNext){disqusjs.page.next=data.cursor.next;$loadMoreBtn.innerHTML="加载更多评论";$loadMoreBtn.classList.remove("dsqjs-hide");$loadMoreBtn.addEventListener(CLICK,getMoreComment)}else{$loadMoreBtn.classList.add("dsqjs-hide")}}else if(data.code===0&&data.response.length===0){msg(`你可能无法访问 Disqus，已启用评论基础模式。${HTML_TPL_EL_ASK_FOR_FULL}`);$$("dsqjs-post-container").innerHTML=`<p class="dsqjs-no-comment" >${disqusjs.config.nocomment}</p>`;assignClickEventForAskForFulButton();$$("dsqjs-force-disqus").addEventListener(CLICK,useDsqjs)}else{throw new Error}}).catch(getCommentError)};const parseCommentData=data=>{let topLevelComments=[];let childComments=[];const commentJSON=comment=>({comment:comment,author:comment.author.name,isPrimary:disqusjs.config.admin?comment.author.username===disqusjs.config.admin:false,children:getChildren(+comment.id),hasMore:comment.hasMore});const getChildren=id=>{if(childComments.length===0)return null;const list=[];childComments.forEach(comment=>{if(comment.parent===id){list.unshift(commentJSON(comment))}});return list.length?list:null};data.forEach(comment=>{const c=comment.parent?childComments:topLevelComments;c.push(comment)});return topLevelComments.map(commentJSON)};const renderComment=data=>{const processData=data=>{if(data.comment.author.profileUrl){data.comment.avatarEl=`<a href="${data.comment.author.profileUrl}" ${HTML_TPL_A_ATTR}><img src="${replaceDisquscdn(data.comment.author.avatar.cache)}"></a>`;data.comment.authorEl=`<span class="dsqjs-post-author"><a href="${data.comment.author.profileUrl}" ${HTML_TPL_A_ATTR}>${data.comment.author.name}</a></span>`}else{data.comment.avatarEl=`<img src="${replaceDisquscdn(data.comment.author.avatar.cache)}">`;data.comment.authorEl=`<span class="dsqjs-post-author">${data.comment.author.name}</span>`}if(disqusjs.config.adminLabel&&data.isPrimary){data.comment.authorEl+=`<span class="dsqjs-admin-badge">${disqusjs.config.adminLabel}</span>`}return data};const removeDisqUs=input=>{const el=document.createElement("div");el.innerHTML=input;const aTag=el.getElementsByTagName("a");Array.prototype.slice.call(aTag).forEach(i=>{const link=decodeURIComponent(i.href.replace(/https:\/\/disq\.us\/url\?url=/g,"")).replace(/(.*):.+cuid=.*/,"$1");i.href=link;i.innerHTML=link;i.rel="external noopener nofollow noreferrer";i.target="_blank"});return el.innerHTML};const replaceDisquscdn=str=>str.replace(/a\.disquscdn\.com/g,"c.disquscdn.com");const renderPostItem=s=>{let authorEl="";let message="";if(s.isDeleted){message=`<small>此评论已被删除</small>`}else{authorEl=`${s.authorEl}<span class="dsqjs-bullet"></span>`;message=removeDisqUs(replaceDisquscdn(s.message))}return HTML_TPL_EL_COMMENT(s,authorEl,message)};const childrenComments=data=>{const nesting=data.nesting;const children=data.children||[];if(!children){return}let html="";if(nesting<disqusjs.config.nesting){html='<ul class="dsqjs-post-list dsqjs-children">'}else{html='<ul class="dsqjs-post-list">'}children.map(comment=>{comment=processData(comment);comment.nesting=nesting+1;const hasMoreEl=comment.hasMore?`<p class="dsqjs-has-more">切换至 <a class="dsqjs-has-more-btn" id="load-more-${comment.comment.id}" data-more-id="comment-${comment.comment.id}">完整 Disqus 模式</a> 显示更多回复</p>`:"";html+=`<li data-id="comment-${comment.comment.id}" id="comment-${comment.comment.id}">${renderPostItem(comment.comment)}${childrenComments(comment)}${hasMoreEl}</li>`});html+="</ul>";if(html.length!==0){return html}else{return}};let html="";parseCommentData(data).map(comment=>{if(comment.children){comment.nesting=1}comment=processData(comment);let hasMoreEl="";if(comment.hasMore){hasMoreEl=`<p class="dsqjs-has-more">切换至 <a id="load-more-${comment.comment.id}">完整 Disqus 模式</a> 显示更多回复</p>`}html+=`<li data-id="comment-${comment.comment.id}" id="comment-${comment.comment.id}">${renderPostItem(comment.comment)}${childrenComments(comment)}${hasMoreEl}</li>`});msg(`你可能无法访问 Disqus，已启用评论基础模式。${HTML_TPL_EL_ASK_FOR_FULL}`);$$("dsqjs-post-container").innerHTML=html;assignClickEventForAskForFulButton()}}function loadError(err){console.log(err);msg('评论基础模式加载失败，是否 <a id="dsqjs-reload-dsqjs" class="dsqjs-msg-btn">重载</a> 或 <a id="dsqjs-reload-disqus" class="dsqjs-msg-btn">尝试完整 Disqus 模式</a> ？');$$("dsqjs-reload-dsqjs").addEventListener(CLICK,loadDsqjs);$$("dsqjs-reload-disqus").addEventListener(CLICK,checkDisqus)}function useDsqjs(){setLS("dsqjs_mode","dsqjs");loadDsqjs()}function useDisqus(){setLS("dsqjs_mode","disqus");loadDisqus()}const disqusjs={};const currentPageFullUrl=document.location.origin+document.location.pathname+document.location.search;disqusjs.config=_extends({api:"https://disqus.skk.moe/disqus/",identifier:currentPageFullUrl,url:currentPageFullUrl,title:document.title,siteName:"",nesting:parseInt(config.nesting)||4,nocomment:"这里冷冷清清的，一条评论都没有"},config);disqusjs.page={};const disqusJsApiKeys=disqusjs.config.apikey;const apikey=()=>Array.isArray(disqusJsApiKeys)?disqusJsApiKeys[Math.floor(Math.random()*disqusJsApiKeys.length)]:disqusJsApiKeys;window.disqus_config=function(){this.page.url=disqusjs.config.url;this.page.identifier=disqusjs.config.identifier;this.page.title=disqusjs.config.title};$$(DISQUS_CONTAINER_EL_ID).innerHTML=`<div id="dsqjs">${HTML_TPL_EL_MSG}${HTML_TPL_EL_FOOTER}</div>`;function initDsqjs(){disqusjs.mode=localStorage.getItem("dsqjs_mode");disqusjs.sortType=localStorage.getItem(DSQJS_STORAGE_KEY_SORT_TYPE)||localStorage.getItem("disqus.sort");if(!disqusjs.sortType){setLS(DSQJS_STORAGE_KEY_SORT_TYPE,"desc");disqusjs.sortType="desc"}if(disqusjs.mode==="disqus"){loadDisqus()}else if(disqusjs.mode==="dsqjs"){loadDsqjs()}else{checkDisqus()}}if(!fetch||!localStorage||!Promise){msg(`你的浏览器版本过低，不兼容评论基础模式。${HTML_TPL_EL_ASK_FOR_FULL}`);assignClickEventForAskForFulButton()}else{initDsqjs()}})(window,document,localStorage,fetch,Promise)}try{module.exports=DisqusJS}catch(e){}