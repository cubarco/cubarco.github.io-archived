<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
<meta name="theme-color" content="#000000">
<title>Writeup: CTFZone 2018 Quals &#8211; /home/cubarco</title>
<meta name="description"
  content="两道PWN题, 一个easypwn_strings, 一个Mobile Bank. easypwn_strings 问题 You can try to use very interesting and strange string functions ;) Good luck. nc pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one 1234 And yes, there is no binary here 这是一道盲pwn类型的题，没有提供二进制(名义上的)。 nc连上之后回显： Let's choose string operation! 1. StrLen 2. SubStrRemove 3. StrRemoveLastSymbols 第一个选项：输入一个字符串，回显字符串长度。 You choise - 1 Use str good choise 123 Result: 3 第二个选项显示未实现。 第三个选项：输入一个字符串，和一个数字，服务端移除末尾指定长度的字符串后打印出来。 You choise - 3 Use str int good choise Set string: 1234567 Set number: 3 Delete 3 ending symbols...">

<meta name="keywords" content="Hack, CTF, Writeup, Exploitation, PWN">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Writeup: CTFZone 2018 Quals">
<meta name="twitter:description"
   content="两道PWN题, 一个easypwn_strings, 一个Mobile Bank. easypwn_strings 问题 You can try to use very interesting and strange string functions ;) Good luck. nc pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one 1234 And yes, there is no binary here 这是一道盲pwn类型的题，没有提供二进制(名义上的)。 nc连上之后回显： Let's choose string operation! 1. StrLen 2. SubStrRemove 3. StrRemoveLastSymbols 第一个选项：输入一个字符串，回显字符串长度。 You choise - 1 Use str good choise 123 Result: 3 第二个选项显示未实现。 第三个选项：输入一个字符串，和一个数字，服务端移除末尾指定长度的字符串后打印出来。 You choise - 3 Use str int good choise Set string: 1234567 Set number: 3 Delete 3 ending symbols...">

<meta name="twitter:site" content="@Cube_Lin">

<meta name="twitter:creator" content="@Cube_Lin">

<meta name="twitter:card" content="summary">
<!--
   -<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/">
   -->

<!-- Open Graph -->
<meta property="og:locale" content="zh_CN">
<meta property="og:type" content="article">
<meta property="og:title" content="Writeup: CTFZone 2018 Quals">
<meta property="og:description"
   content="两道PWN题, 一个easypwn_strings, 一个Mobile Bank. easypwn_strings 问题 You can try to use very interesting and strange string functions ;) Good luck. nc pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one 1234 And yes, there is no binary here 这是一道盲pwn类型的题，没有提供二进制(名义上的)。 nc连上之后回显： Let's choose string operation! 1. StrLen 2. SubStrRemove 3. StrRemoveLastSymbols 第一个选项：输入一个字符串，回显字符串长度。 You choise - 1 Use str good choise 123 Result: 3 第二个选项显示未实现。 第三个选项：输入一个字符串，和一个数字，服务端移除末尾指定长度的字符串后打印出来。 You choise - 3 Use str int good choise Set string: 1234567 Set number: 3 Delete 3 ending symbols...">
<meta property="og:url" content="https://cubl.in/blog/2018/07/writeup-ctfzone/">
<meta property="og:site_name" content="/home/cubarco">





<link rel="canonical" href="https://cubl.in/blog/2018/07/writeup-ctfzone/">
<link href="https://cubl.in/feed.xml" type="application/atom+xml" rel="alternate" title="/home/cubarco Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/assets/css/main.css">
<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/cdnjs/cdnjs@95f0cba887c60c1b8c7944d59442a02623193751/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">

<!--Webfonts-->
<link href='//fonts.googleapis.com/css?family=Volkhov|Cabin' rel='stylesheet' type='text/css'>
<!--
   -[> Webfonts <]
   -<script src="//use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov;cabin.js"></script>
   -->

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/assets/js/vendor/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<!--<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>-->
<script
  src="https://cdn.jsdelivr.net/gh/cdnjs/cdnjs@95f0cba887c60c1b8c7944d59442a02623193751/ajax/libs/modernizr/2.7.1/modernizr.min.js"></script>

<!-- Icons -->
<!--
   -[> 16x16 <]
   -<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/favicon-16x16.ico">
   -[> 32x32 <]
   -<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/favicon-32x32.ico">
   -[> 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices <]
   -<link rel="apple-touch-icon-precomposed" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/apple-touch-icon-precomposed.png">
   -[> 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini <]
   -<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/apple-touch-icon-72x72-precomposed.png">
   -[> 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch <]
   -<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/apple-touch-icon-114x114-precomposed.png">
   -[> 144x144 (precomposed) for iPad 3rd and 4th generation <]
   -<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/apple-touch-icon-144x144-precomposed.png">
   -->
<!--
<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/favicon.ico">
<link rel="apple-touch-icon" sizes="57x57" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/favicons/favicon-16x16.png" sizes="16x16">
-->

</head>

<body id="post">

  <div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
		<ul>
			
			
			<li><a href="https://cubl.in/blog/">Latest</a></li>
			
			
			<li><a href="https://cubl.in/blog/about/">About</a></li>
			
			
			<li><a href="https://cubl.in/blog/category/blog/">Blog</a></li>
			
			
			<li><a href="https://cubl.in/blog/category/notes/">Notes</a></li>
			
			
			<li><a href="https://cubl.in/blog/tags/">Tags</a></li>
			
			<li class="dosearch"><span><i class="fa fa-search"></i> Search</span></li>
		</ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="search-wrapper">
  <div class="search-form">
    <input type="text" class="search-field" placeholder="Search...">
    <button class="close-btn"><i class="fa fa-times-circle fa-2x"></i></button>
    <ul class="search-results post-list"></ul>
<!-- /.search-results -->
  </div>
<!-- /.search-form -->
</div><!-- ./search-wrapper -->

<div class="js-menu-screen menu-screen"></div>

  <div id="main" role="main">
    <article class="hentry">
      
      <div class="entry-wrapper">
        <header class="entry-header">
          <span class="entry-tags"><a href="https://cubl.in/blog/tags/#Hack" title="Pages tagged Hack">Hack</a> • <a href="https://cubl.in/blog/tags/#CTF" title="Pages tagged CTF">CTF</a> • <a href="https://cubl.in/blog/tags/#Writeup" title="Pages tagged Writeup">Writeup</a> • <a href="https://cubl.in/blog/tags/#Exploitation" title="Pages tagged Exploitation">Exploitation</a> • <a href="https://cubl.in/blog/tags/#PWN" title="Pages tagged PWN">PWN</a></span>
          
          <h1 class="entry-title">Writeup: CTFZone 2018 Quals</h1>
          
        </header>
        <footer class="entry-meta">
          
          
          <span class="author vcard">By <span class="fn">Cubarco</span></span>
          <span class="entry-date date published"><time datetime="2018-07-23T00:00:00+00:00"><i class="fa fa-calendar-o"></i> July 23, 2018</time></span>
          <span class="entry-date date modified"><time datetime="2018-07-24"><i class="fa fa-pencil"></i> July 24, 2018</time></span>
          <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
          <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=Hack,CTF,Writeup,Exploitation,PWN&amp;text=Writeup:%20CTFZone%202018%20Quals&amp;url=https://cubl.in/blog/2018/07/writeup-ctfzone/&amp;via=Cube_Lin" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://cubl.in/blog/2018/07/writeup-ctfzone/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<!-- /.social-share -->
          
        </footer>
        <div class="entry-content">
          <p>两道PWN题, 一个easypwn_strings, 一个Mobile Bank.</p>

<h1 id="easypwn_strings">easypwn_strings</h1>

<h3 id="问题">问题</h3>

<blockquote>
  <p>You can try to use very interesting and strange string functions ;) Good luck. <code class="highlighter-rouge">nc pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one 1234</code> And yes, there is no binary here</p>
</blockquote>

<p>这是一道<strong>盲pwn</strong>类型的题，没有提供二进制<del>(名义上的)</del>。</p>

<p>nc连上之后回显：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Let's choose string operation!
	1. StrLen
	2. SubStrRemove
	3. StrRemoveLastSymbols
</code></pre></div></div>

<p>第一个选项：输入一个字符串，回显字符串长度。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You choise - 1
	Use str
	good choise
123
	Result: 3
</code></pre></div></div>

<p>第二个选项显示未实现。</p>

<p>第三个选项：输入一个字符串，和一个数字，服务端移除末尾指定长度的字符串后打印出来。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You choise - 3
	Use str int
	good choise
	Set string:
1234567
	Set number:
3
	Delete 3 ending symbols
	Result:
1234
</code></pre></div></div>

<h3 id="思路">思路</h3>

<p>既然是无ELF文件的盲pwn，那只能摸着石头过河。做题时有以下几个尝试：</p>

<ol>
  <li><del>三个选项的输入是否有溢出；</del></li>
  <li><del>未实现的选项2是否有隐藏功能；</del></li>
  <li><del>选项3输入的数字是否可以为负数，可能造成字符串拷贝时的溢出或者泄密问题；</del></li>
  <li>…</li>
</ol>

<p>很多尝试以失败告终。最终找到的漏洞是功能3的<strong>格式化字符串漏洞</strong>：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You choise - 3
	Use str int
	good choise
	Set string:
%p %p %p
	Set number:
0
	Delete 3 ending symbols
	Result:
0xffe96350 0x8 0xf75fc1a4
</code></pre></div></div>

<p>我们可以利用这个格式化字符串漏洞构造一个任意地址读，然后把内存中的ELF dump下来。</p>

<p>怎么dump？可以参考YouTube上一个视频：<a href="https://www.youtube.com/watch?v=XuzuFUGuQv0">Format String to dump binary and gain RCE - 33c3ctf ESPR (pwn 150)</a>.</p>

<p>这道题和ESPR有两点区别：</p>

<ol>
  <li>ESPR的输入只限制了<code class="highlighter-rouge">\n</code>字符，但是这题的输入不能包含<code class="highlighter-rouge">\n</code>和<code class="highlighter-rouge">\x00</code>，猜测是用了<code class="highlighter-rouge">fgets</code>和<code class="highlighter-rouge">strcpy</code>。所以在dump下来的二进制中会有一些遗漏位，不过对这道题来说无伤大雅；</li>
  <li>ESPR一个进程循环不断调用<code class="highlighter-rouge">printf</code>，但是这题进程只有一个流程，没有循环，所以需要不断与服务器创建连接，十分耗时。好在需要dump的是ELF，内容是固定的。</li>
</ol>

<p>dump脚本：</p>

<div class="gist" data-gist="cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa" data-gist-file="strings-dump.py"><p>Gist: <a href="https://gist.github.com/cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa">cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa</a></p></div>

<h3 id="漏洞gets溢出">漏洞（gets溢出）</h3>

<p>把ELF dump下来之后跑一下<code class="highlighter-rouge">strings dump.raw</code>，看到一些有意思的字符串：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>strings dump.raw
...
	Delete %i ending symbols
	Result:
https://ctf.bi.zone/files/babypwn
https://ctf.bi.zone/files/babylibc
main.c
Have a <span class="nb">nice </span>day!
ctfzone<span class="o">{</span>1t_1s_<span class="nv">$uP6r_F4k6_4H4H</span><span class="o">}</span>
ctfzone<span class="o">{</span><span class="nv">$uP6r_F4k6_4H4H4H_t00</span><span class="o">}</span>
...
</code></pre></div></div>

<p><del>除了有两行假装是flag的信息，还</del>有两行URL，看来是提供了二进制和libc的：</p>

<ol>
  <li>https://ctf.bi.zone/files/babypwn</li>
  <li>https://ctf.bi.zone/files/babylibc</li>
</ol>

<p>IDA打开babypwn，发现main函数还藏了两个菜单选项：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">v3</span> <span class="o">=</span> <span class="n">_IO_getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
  <span class="n">_IO_getc</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">==</span> <span class="sc">'1'</span> <span class="o">||</span> <span class="n">v3</span> <span class="o">==</span> <span class="sc">'2'</span> <span class="o">||</span> <span class="n">v3</span> <span class="o">==</span> <span class="sc">'3'</span> <span class="o">||</span> <span class="n">v3</span> <span class="o">==</span> <span class="sc">'X'</span> <span class="o">||</span> <span class="n">v3</span> <span class="o">==</span> <span class="sc">'T'</span> <span class="o">||</span> <span class="n">v3</span> <span class="o">==</span> <span class="sc">'S'</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"You choise - %c</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
    <span class="p">...</span>
  	<span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="sc">'X'</span> <span class="o">&amp;&amp;</span> <span class="n">v3</span> <span class="o">!=</span> <span class="sc">'T'</span> <span class="p">)</span>
	  <span class="p">...</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">puts</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">Are you surprised?? (y or n)</span><span class="se">\r</span><span class="s">"</span><span class="p">);</span>
      <span class="n">gets</span><span class="p">(</span><span class="n">gets_buf</span><span class="p">);</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">gets_buf</span><span class="p">,</span> <span class="sc">'y'</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v1</span> <span class="p">)</span>
        <span class="n">func_ptr</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">gets</code>是明显的危险函数，<code class="highlighter-rouge">gets_buf</code>上存在溢出，再看溢出到哪：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.bss:080492E0 ; char gets_buf[256]
.bss:080492E0 gets_buf        db 100h dup(0)          ; DATA XREF: main+62↑o
.bss:080492E0                                         ; main+245↑o ...
.bss:080493E0 ; int (__cdecl *func_ptr)(_DWORD, _DWORD, _DWORD)
.bss:080493E0 func_ptr        dd 0                    ; DATA XREF: main+18F↑w
.bss:080493E0                                         ; main+1AE↑w ...
</code></pre></div></div>

<p>可以盖到<code class="highlighter-rouge">func_ptr</code>这个函数指针，所以这个溢出已经可以用来<strong>劫持控制流</strong>了。</p>

<h3 id="exp">EXP</h3>

<p>checksec一下babypwn文件:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[*] '/tmp/babypwn'
    Arch:     i386-32-little
    RELRO:    No RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
    RWX:      Has RWX segments
</code></pre></div></div>

<p>有RWX的段，用GDB挂上ELF看一下map:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gef&gt; vmmap
Start      End        Offset     Perm Path
0x08048000 0x0804c000 0x00000000 rwx /tmp/babypwn
0x0804c000 0x0804d000 0x00000000 rw- [heap]
0xf7dbf000 0xf7f93000 0x00000000 r-x /usr/lib32/libc-2.27.so
0xf7f93000 0xf7f94000 0x001d4000 --- /usr/lib32/libc-2.27.so
...
</code></pre></div></div>

<p>整个ELF都是RWX的<del>(这题有毒…)</del>，那很简单了，之前溢出的<code class="highlighter-rouge">gets_buf</code>就在bss段上，可写可执行，还知道地址。只要把shellcode写到<code class="highlighter-rouge">gets_buf</code>上，然后溢出到<code class="highlighter-rouge">func_ptr</code>，指向<code class="highlighter-rouge">gets_buf</code>，就执行shellcode了。</p>

<p>利用脚本：</p>

<div class="gist" data-gist="cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa" data-gist-file="strings-exp.py"><p>Gist: <a href="https://gist.github.com/cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa">cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa</a></p></div>

<hr>

<h1 id="mobile-bank">Mobile Bank</h1>

<h3 id="问题-1">问题</h3>

<blockquote>
  <p>We bring your attention to a new, unique product: “Mobile Bank”! It’s a completely secure banking server running on mobile platforms. Now the Bank is in your pocket! <code class="highlighter-rouge">nc pwn-04.v7frkwrfyhsjtbpfcppnu.ctfz.one 1337</code></p>

  <p><a href="https://ctf.bi.zone/files/mobile_bank.45115ff5f655d94fc26cb5244928b3fc">mobile_bank</a></p>
</blockquote>

<p>下载二进制，checksec一下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[*] '/pwn/bank/mobile_bank'
    Arch:     arm-32-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x10000)
</code></pre></div></div>

<p>是一个arm32的二进制。nc连上去看是什么内容：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         _._._                       _._._
        _|   |_                     _|   |_
        | ... |_._._._._._._._._._._| ... |
        | ||| |  o NATIONAL BANK o  | ||| |
        | """ |  """    """    """  | """ |
   ())  |[-|-]| [-|-]  [-|-]  [-|-] |[-|-]|  ())
  (())) |     |---------------------|     | (()))
 (())())| """ |  """    """    """  | """ |(())())
 (()))()|[-|-]|  :::   .-"-.   :::  |[-|-]|(()))()
 ()))(()|     | |~|~|  |_|_|  |~|~| |     |()))(()
    ||  |_____|_|_|_|__|_|_|__|_|_|_|_____|  ||
 ~ ~^^ @@@@@@@@@@@@@@/=======\@@@@@@@@@@@@@@ ^^~ ~
      ^~^~                                ~^~^
*******************$$$Menu$$$*******************
* 1 - info                                     *
* 2 - set account id                           *
* 3 - set account note                         *
* 4 - make transaction                         *
* 5 - print account info                       *
* 6 - enable debug                             *
* 0 - exit                                     *
************************************************
Your choice:
</code></pre></div></div>

<p>还是一道菜单题。大概意思是这是一个bank，选项1打印当前的账户id和debug是否开启；选项2设置当前操作的账户id；选项3设置这个账户的note；选项4给当前账户加上指定数额的金钱数；选项5打印当前账户的id、账户余额、账户note；选项6打开debug功能。</p>

<p>用IDA打开，看到有一个选项7，<code class="highlighter-rouge">debug_info</code>：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="k">case</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">debug_enabled</span> <span class="p">)</span>
          <span class="n">debug_info</span><span class="p">();</span>
        <span class="k">else</span>
          <span class="nf">puts</span><span class="p">(</span><span class="s">"Invalid command!"</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
</code></pre></div></div>

<p>这个debug_info的功能是，打印出所有16个账户的id、余额和note 。</p>

<h3 id="漏洞">漏洞</h3>

<h4 id="1-account_id越界">1. account_id越界</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">set_id</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// r0@1</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">"Enter account id: "</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">readint</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="s">"Wrong account id!"</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这是选项2的实现，通过<code class="highlighter-rouge">readint</code>读入<code class="highlighter-rouge">int</code>型数据，若小于15便赋值给全局变量<code class="highlighter-rouge">account_id</code>. 漏洞在于这里是<strong>可以输入负值</strong>的，而这个<code class="highlighter-rouge">account_id</code>在多个选项中被当作数组下标来使用，所以会有下越界的问题。</p>

<p>这个漏洞可以实现什么？有四点：</p>

<ol>
  <li>
<strong>受限的任意地址读</strong>（选项5）；</li>
  <li>
<strong>受限的任意地址写</strong>（选项4）；</li>
  <li>受限的任意地址读指针内容（选项5）；</li>
  <li>受限的任意地址赋值为堆上的指针（选项3）。</li>
</ol>

<p>3、4两点这里用处不大，所以不讲。这里讲下1、2两点。虽然通过负值的<code class="highlighter-rouge">account_id</code>实现了一定程度的任意地址读写，但是毕竟还是受限的。</p>

<p>以下是选项5的实现：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">account_info</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">v0</span><span class="p">;</span> <span class="c1">// r3@2</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// r0@4</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// [sp+Ch] [bp-158h]@4</span>
  <span class="kt">int</span> <span class="n">v3</span><span class="p">;</span> <span class="c1">// [sp+15Ch] [bp-8h]@1</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">_stack_chk_guard</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">notes_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">account_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="n">notes_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">account_id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
  <span class="k">else</span>
    <span class="n">v0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unk_1196C</span><span class="p">;</span>
  <span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x150u</span><span class="p">,</span> <span class="s">"id: %u, value: %d$, note:</span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="n">account_id</span><span class="p">,</span> <span class="n">notes_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">account_id</span><span class="p">],</span> <span class="n">v0</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v3</span> <span class="o">!=</span> <span class="n">_stack_chk_guard</span> <span class="p">)</span>
    <span class="n">_stack_chk_fail</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">notes_arr</code>是bss段上的数组，基址是0x22088，而输入的<code class="highlighter-rouge">account_id</code>必须要小于等于15，所以这里对需要读写的地址addr有3点限制：</p>

<ol>
  <li>addr到0x22088的offset必须是<strong>8的倍数</strong>；</li>
  <li>addr+4的位置<strong>必须为0</strong>或是一个<strong>合理的指针</strong>；</li>
  <li>除非addr<strong>小于<code class="highlighter-rouge">notes_arr</code>的地址</strong>（比如GOT、.text、.data段），不然addr的值不能太小，<code class="highlighter-rouge">addr - notes_arr</code>的值在<strong>无符号int32上必须表现为负数</strong>。</li>
</ol>

<h4 id="2-debug_info越界写">2. debug_info越界写</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">debug_info</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">n</span><span class="p">;</span> <span class="c1">// ST14_4@4</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v1</span><span class="p">;</span> <span class="c1">// r3@5</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// r0@6</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// [sp+Ch] [bp-218h]@1</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// [sp+Ch] [bp-218h]@3</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [sp+10h] [bp-214h]@1</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">v6</span><span class="p">;</span> <span class="c1">// [sp+18h] [bp-20Ch]@3</span>
  <span class="kt">char</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// [sp+1Ch] [bp-208h]@1</span>
  <span class="kt">int</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [sp+21Ch] [bp-8h]@1</span>

  <span class="n">v8</span> <span class="o">=</span> <span class="n">_stack_chk_guard</span><span class="p">;</span>
  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x200u</span><span class="p">);</span>
  <span class="n">v3</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v3</span><span class="p">[</span><span class="n">snprintf</span><span class="p">(</span><span class="n">v3</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v8</span> <span class="o">-</span> <span class="n">v3</span><span class="p">,</span> <span class="s">"%u</span><span class="se">\t</span><span class="s">%d$</span><span class="se">\t</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">notes_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">])];</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">notes_arr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">v6</span><span class="p">);</span>
      <span class="n">memcpy</span><span class="p">(</span><span class="n">v4</span><span class="p">,</span> <span class="n">v6</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
      <span class="n">v4</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">v4</span><span class="p">;</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">v4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">*</span><span class="n">v1</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">debug_info</code>直接拿<code class="highlighter-rouge">snprintf</code>返回值做数组下标，移动v3指针。这是对<code class="highlighter-rouge">snprintf</code>返回值的一个典型误用。</p>

<blockquote>
  <p>RETURN VALUE</p>

  <p>The functions snprintf() and vsnprintf() do not write  more  than  size bytes  (including the terminating null byte (‘\0’)).  If the output was truncated due to this limit, then the return value  is  the  number  of characters  (excluding the terminating null byte) which <strong>would have been</strong> written to the final string if enough space had been available. Thus, a  return  value  of  size or more means that the output was truncated. (See also below under NOTES.)</p>
</blockquote>

<p>看man文档其实就可以发现，snprintf返回的不是实际往目标buf里写了多少字节，而是<strong>本应写多少字节</strong>。这个漏洞利用后其实可以<strong>越过stack cookie</strong>写值，<strong>绕过canary保护</strong>，实现<strong>ROP</strong>攻击。但是<strong>buf中不能出现null byte</strong>，而且我对ARM下的ROP不熟，所以这个思路在赛间只是个备选项。</p>

<p><strong>P.S.</strong> 这个debug选项可以通过上文的「受限的任意地址赋值为堆上的指针」来打开，这里不再赘述。</p>

<p><strong>P.S.S.</strong> 其实我用qemu调这个二进制的时候，发现stack是rwx（可写可执行）的<del>（这个比赛真的有毒。。。）</del>。但是如果想要leak栈地址，其实还是需要一个任意地址读。可是回过头来，如果有了任意地址读，还需要做ROP这么复杂的利用吗？</p>

<h3 id="exp-1">EXP</h3>

<p>我的利用思路个人感觉比较清奇，需要绕个小弯，是在洗澡的时候想出来的<del>（又一次）</del>。</p>

<p>这个利用只用到了<code class="highlighter-rouge">account_id</code>越界这个漏洞，具体步骤是：</p>

<ol>
  <li>通过受限的任意地址读，读<code class="highlighter-rouge">memcmp_got</code>的值（不管是不是已经被<code class="highlighter-rouge">dl-resolve</code>了，只是需要这个值来计算差值）；</li>
  <li>通过受限的任意地址写，把<code class="highlighter-rouge">printf_plt</code>的值写到<code class="highlighter-rouge">memcmp_got</code>上去（这一步需要计算<code class="highlighter-rouge">memcmp_got</code>到<code class="highlighter-rouge">printf_plt</code>的差值），<strong>此时memcmp已经变成了printf</strong>；</li>
  <li>选项6的<code class="highlighter-rouge">enable_debug</code>函数用到了memcmp，而且第一个参数就是用户输入的字符串，所以这里<del>强行</del>构造了一个FSB漏洞，可以精心构造Format String来实现任意地址读：</li>
  <li>利用pwntools的DynELF工具，结合在<code class="highlighter-rouge">enable_debug</code>构造的任意地址读（即leak），泄密libc上的<code class="highlighter-rouge">system</code>函数地址；</li>
  <li>通过受限的任意地址写，将<code class="highlighter-rouge">system</code>函数地址写到<code class="highlighter-rouge">memcmp_got</code>上，调用<code class="highlighter-rouge">enable_debug</code>，传入<code class="highlighter-rouge">/bin/sh</code>，getshell.</li>
</ol>

<p>exp.py:</p>

<div class="gist" data-gist="cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa" data-gist-file="bank-exp.py"><p>Gist: <a href="https://gist.github.com/cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa">cubarco/9bfafbc77dd2c0330e3c0ef87013c6fa</a></p></div>

          <div align="right">
            <span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/images/cc_by-nc_88x31.png"></a></span>
          </div>
          <nav class="pagination" role="navigation">
            
            <a href="https://cubl.in/blog/2016/04/how-to-set-up-a-duckduckgo-proxy-site-with-nginx/" class="btn" title="如何用 Nginx 搭建简单的 DuckDuckGo 代理站">Previous</a>
            
            
          </nav><!-- /.pagination -->
          <div id="disqus_thread"></div>
          <!-- /#disqus_thread -->
        </div>
<!-- /.entry-content -->
      </div>
<!-- /.entry-wrapper -->

    </article>
  </div><!-- /#main -->

  <div class="footer-wrapper">
    <footer role="contentinfo" class="entry-wrapper">
      

<span>Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple
		Theme</a>. Published with <a href="https://docs.github.com/en/github/working-with-github-pages/creating-a-github-pages-site">Github
		Pages</a>.</span>
<div class="social-icons">
	<a href="https://twitter.com/Cube_Lin" title="Cubarco on Twitter" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
	
	
	
	
	
	
	<a href="https://github.com/cubarco" title="Cubarco on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
	<a href="https://cubl.in/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div>
<!-- /.social-icons -->
    </footer>
  </div><!-- /.footer-wrapper -->

  <script src="https://cdn.jsdelivr.net/gh/cdnjs/cdnjs@95f0cba887c60c1b8c7944d59442a02623193751/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/assets/js/gist-async.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/assets/js/scripts.min.js"></script>

<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function () {
    $('.search-field').jekyllSearch({
      jsonFile: 'https://cdn.jsdelivr.net/gh/cubarco/cubarco.github.io@2021-0301-064612-23629/search.json',
      searchResults: '.search-results',
      template: '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
      fuzzy: true,
      noResults: '<p>Nothing found.</p>'
    });
  });

  (function ($, window, undefined) {

    var bs = {
      close: $(".close-btn"),
      searchform: $(".search-form"),
      canvas: $(".js-menu-screen"),
      dothis: $('.dosearch')
    };

    bs.dothis.on('click', function () {
      $('.search-wrapper').css({ display: "block" });
      $('body').toggleClass('no-scroll');
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('is-visible');
    });

    bs.close.on('click', function () {
      $('.search-wrapper').removeAttr('style');
      $('body').toggleClass('no-scroll');
      bs.searchform.toggleClass('active');
      bs.canvas.removeClass('is-visible');
    });
  })(jQuery, window);
</script>


<!-- Check whether the page is a post -->


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css">
<script id="dsqjs-script" src="https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqus.js"></script>
<script>
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'cubarco';
    var disqus_siteName = '/home/cubarco';
    var disqus_api = 'https://disqus.cubl.in/';
    var disqus_apikey = 'Jw86RA4MHn7FOX9T3JdY2rdOwXIHztQXp1QGQzvEjil3rXPCOfIrn4yF53NEOcho';
    var disqus_admin = 'cubarco';
    var disqus_adminLabel = 'Mod';
    var dsqjs = new DisqusJS({
        shortname: disqus_shortname,
        siteName: disqus_siteName,
        api: disqus_api,
        apikey: disqus_apikey,
        admin: disqus_admin,
        adminLabel: disqus_adminLabel
    });
</script>




<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
    '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-54867602-1']);
  _gaq.push(['_trackPageview']);

  (function () {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


</body>

</html>